# 前端接口文档 - 登录注册模块

## 基本信息

**Base URL:** `http://localhost:8080/api`

**请求头：**
- `Content-Type: application/json`
- `Authorization: Bearer {token}` （需要认证的接口）

**响应格式：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": 1706025600000
}
```

---

## 1. 用户注册

### 接口信息
- **URL:** `/auth/register`
- **Method:** `POST`
- **认证:** 不需要

### 请求参数

| 字段名 | 类型 | 必填 | 说明 | 校验规则 |
|--------|------|------|------|----------|
| username | string | 是 | 用户名 | 3-20位，只能包含字母、数字、下划线 |
| password | string | 是 | 密码 | 6-20位 |
| phone | string | 是 | 手机号 | 11位手机号，1开头 |
| nickname | string | 否 | 昵称 | 最多50个字符 |

### 请求示例

```json
{
  "username": "zhangsan",
  "password": "123456",
  "phone": "13800138000",
  "nickname": "张三"
}
```

### 响应示例

**成功响应 (200):**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null,
  "timestamp": 1706025600000
}
```

**失败响应 - 用户名已存在 (200):**
```json
{
  "code": 4001,
  "message": "用户名已存在",
  "data": null,
  "timestamp": 1706025600000
}
```

**失败响应 - 手机号已存在 (200):**
```json
{
  "code": 4002,
  "message": "手机号已存在",
  "data": null,
  "timestamp": 1706025600000
}
```

**失败响应 - 参数校验失败 (400):**
```json
{
  "code": 400,
  "message": "用户名长度必须在3-20之间",
  "data": null,
  "timestamp": 1706025600000
}
```

### 前端处理建议

1. 注册成功后，提示用户并跳转到登录页
2. 用户名已存在时，提示用户更换用户名
3. 手机号已存在时，提示用户该手机号已注册
4. 参数校验失败时，显示具体的错误信息

---

## 2. 用户登录

### 接口信息
- **URL:** `/auth/login`
- **Method:** `POST`
- **认证:** 不需要

### 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| username | string | 是 | 用户名或手机号 |
| password | string | 是 | 密码 |

### 请求示例

```json
{
  "username": "zhangsan",
  "password": "123456"
}
```

或使用手机号登录：
```json
{
  "username": "13800138000",
  "password": "123456"
}
```

### 响应示例

**成功响应 (200):**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ6aGFuZ3NhbiIsImlhdCI6MTcwNjAyNTYwMCwiZXhwIjoxNzA2NjMwNDAwfQ.xxx",
    "tokenType": "Bearer",
    "expiresIn": 604800,
    "userInfo": {
      "userId": 1,
      "username": "zhangsan",
      "nickname": "张三",
      "phone": "13800138000",
      "avatar": null,
      "name": null,
      "warningThreshold": null,
      "status": 1,
      "roles": []
    }
  },
  "timestamp": 1706025600000
}
```

**失败响应 - 用户名或密码错误 (200):**
```json
{
  "code": 4003,
  "message": "用户名或密码错误",
  "data": null,
  "timestamp": 1706025600000
}
```

**失败响应 - 账号已被禁用 (200):**
```json
{
  "code": 4004,
  "message": "账号已被禁用",
  "data": null,
  "timestamp": 1706025600000
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| token | string | JWT令牌，后续请求需要携带 |
| tokenType | string | 令牌类型，固定为"Bearer" |
| expiresIn | number | 过期时间（秒），默认7天 |
| userInfo | object | 用户信息对象 |
| userInfo.userId | number | 用户ID |
| userInfo.username | string | 用户名 |
| userInfo.nickname | string | 昵称 |
| userInfo.phone | string | 手机号 |
| userInfo.avatar | string | 头像URL |
| userInfo.name | string | 真实姓名 |
| userInfo.warningThreshold | number | 占位预警阈值（分钟） |
| userInfo.status | number | 账号状态（0-禁用, 1-启用） |
| userInfo.roles | array | 角色列表 |

### 前端处理建议

1. 登录成功后：
   - 将token存储到localStorage或sessionStorage
   - 将用户信息存储到Pinia/Vuex
   - 跳转到首页或来源页
2. 登录失败时，显示错误提示
3. 记住密码功能（可选）

---

## 3. 获取当前用户信息

### 接口信息
- **URL:** `/auth/current`
- **Method:** `GET`
- **认证:** 需要

### 请求头

```
Authorization: Bearer {token}
```

### 响应示例

**成功响应 (200):**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "userId": 1,
    "username": "zhangsan",
    "nickname": "张三",
    "phone": "13800138000",
    "avatar": "http://example.com/avatar.jpg",
    "name": "张三",
    "warningThreshold": 15,
    "status": 1,
    "roles": []
  },
  "timestamp": 1706025600000
}
```

**失败响应 - 未登录 (401):**
```json
{
  "code": 401,
  "message": "未认证，请先登录",
  "data": null,
  "timestamp": 1706025600000
}
```

**失败响应 - Token已过期 (200):**
```json
{
  "code": 4005,
  "message": "Token已过期",
  "data": null,
  "timestamp": 1706025600000
}
```

### 前端处理建议

1. 在应用启动时调用此接口，验证token是否有效
2. 如果返回401或4005，清除本地token并跳转到登录页
3. 成功后更新Pinia/Vuex中的用户信息

---

## 4. 更新用户资料

### 接口信息
- **URL:** `/auth/profile`
- **Method:** `PUT`
- **认证:** 需要

### 请求头

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

| 字段名 | 类型 | 必填 | 说明 | 校验规则 |
|--------|------|------|------|----------|
| nickname | string | 否 | 昵称 | 最多50个字符 |
| avatar | string | 否 | 头像URL | 最多255个字符 |
| name | string | 否 | 真实姓名 | 最多50个字符 |
| warningThreshold | number | 否 | 占位预警阈值（分钟） | 正整数 |

### 请求示例

```json
{
  "nickname": "新昵称",
  "avatar": "http://example.com/avatar.jpg",
  "name": "张三",
  "warningThreshold": 20
}
```

### 响应示例

**成功响应 (200):**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "userId": 1,
    "username": "zhangsan",
    "nickname": "新昵称",
    "phone": "13800138000",
    "avatar": "http://example.com/avatar.jpg",
    "name": "张三",
    "warningThreshold": 20,
    "status": 1,
    "roles": []
  },
  "timestamp": 1706025600000
}
```

### 前端处理建议

1. 更新成功后，更新Pinia/Vuex中的用户信息
2. 显示成功提示
3. 头像上传可以先调用文件上传接口，获取URL后再调用此接口

---

## 5. 修改密码

### 接口信息
- **URL:** `/auth/password`
- **Method:** `PUT`
- **认证:** 需要

### 请求头

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

| 字段名 | 类型 | 必填 | 说明 | 校验规则 |
|--------|------|------|------|----------|
| oldPassword | string | 是 | 旧密码 | - |
| newPassword | string | 是 | 新密码 | 6-20位 |

### 请求示例

```json
{
  "oldPassword": "123456",
  "newPassword": "654321"
}
```

### 响应示例

**成功响应 (200):**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null,
  "timestamp": 1706025600000
}
```

**失败响应 - 旧密码错误 (200):**
```json
{
  "code": 4007,
  "message": "旧密码错误",
  "data": null,
  "timestamp": 1706025600000
}
```

### 前端处理建议

1. 修改成功后，清除本地token
2. 提示用户"密码修改成功，请重新登录"
3. 跳转到登录页

---

## 6. 用户登出

### 接口信息
- **URL:** `/auth/logout`
- **Method:** `POST`
- **认证:** 需要

### 请求头

```
Authorization: Bearer {token}
```

### 响应示例

**成功响应 (200):**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null,
  "timestamp": 1706025600000
}
```

### 前端处理建议

1. 登出成功后，清除本地token
2. 清除Pinia/Vuex中的用户信息
3. 跳转到登录页

---

## 错误码说明

| 错误码 | 说明 | 前端处理建议 |
|--------|------|--------------|
| 200 | 操作成功 | 正常处理 |
| 400 | 请求参数错误 | 显示错误信息 |
| 401 | 未认证（未登录） | 跳转到登录页 |
| 403 | 无权限访问 | 显示"无权限"提示 |
| 404 | 资源不存在 | 显示"资源不存在" |
| 500 | 服务器内部错误 | 显示"服务器错误，请稍后重试" |
| 4001 | 用户名已存在 | 提示用户更换用户名 |
| 4002 | 手机号已存在 | 提示该手机号已注册 |
| 4003 | 用户名或密码错误 | 提示用户检查账号密码 |
| 4004 | 账号已被禁用 | 提示账号已被禁用，联系管理员 |
| 4005 | Token已过期 | 清除token，跳转到登录页 |
| 4006 | Token无效 | 清除token，跳转到登录页 |
| 4007 | 旧密码错误 | 提示旧密码错误 |
| 4008 | 用户不存在 | 提示用户不存在 |

---

## Axios请求封装示例

### 1. 创建Axios实例

```javascript
// src/utils/request.js
import axios from 'axios'
import { ElMessage } from 'element-plus'
import router from '@/router'

const request = axios.create({
  baseURL: 'http://localhost:8080/api',
  timeout: 10000
})

// 请求拦截器
request.interceptors.request.use(
  config => {
    // 从localStorage获取token
    const token = localStorage.getItem('token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  error => {
    return Promise.reject(error)
  }
)

// 响应拦截器
request.interceptors.response.use(
  response => {
    const { code, message, data } = response.data

    // 成功
    if (code === 200) {
      return data
    }

    // Token过期或无效
    if (code === 401 || code === 4005 || code === 4006) {
      ElMessage.error('登录已过期，请重新登录')
      localStorage.removeItem('token')
      router.push('/login')
      return Promise.reject(new Error(message))
    }

    // 其他错误
    ElMessage.error(message || '请求失败')
    return Promise.reject(new Error(message))
  },
  error => {
    if (error.response?.status === 401) {
      ElMessage.error('登录已过期，请重新登录')
      localStorage.removeItem('token')
      router.push('/login')
    } else {
      ElMessage.error(error.message || '网络错误')
    }
    return Promise.reject(error)
  }
)

export default request
```

### 2. 封装API接口

```javascript
// src/api/auth.js
import request from '@/utils/request'

/**
 * 用户注册
 */
export function register(data) {
  return request({
    url: '/auth/register',
    method: 'post',
    data
  })
}

/**
 * 用户登录
 */
export function login(data) {
  return request({
    url: '/auth/login',
    method: 'post',
    data
  })
}

/**
 * 获取当前用户信息
 */
export function getCurrentUser() {
  return request({
    url: '/auth/current',
    method: 'get'
  })
}

/**
 * 更新用户资料
 */
export function updateProfile(data) {
  return request({
    url: '/auth/profile',
    method: 'put',
    data
  })
}

/**
 * 修改密码
 */
export function changePassword(data) {
  return request({
    url: '/auth/password',
    method: 'put',
    data
  })
}

/**
 * 用户登出
 */
export function logout() {
  return request({
    url: '/auth/logout',
    method: 'post'
  })
}
```

### 3. 使用示例

```vue
<script setup>
import { ref } from 'vue'
import { login } from '@/api/auth'
import { useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'

const router = useRouter()
const loginForm = ref({
  username: '',
  password: ''
})

const handleLogin = async () => {
  try {
    const data = await login(loginForm.value)

    // 保存token
    localStorage.setItem('token', data.token)

    // 保存用户信息（可选）
    localStorage.setItem('userInfo', JSON.stringify(data.userInfo))

    ElMessage.success('登录成功')
    router.push('/')
  } catch (error) {
    // 错误已在拦截器中处理
  }
}
</script>
```

---

## 路由守卫示例

```javascript
// src/router/index.js
import { createRouter, createWebHistory } from 'vue-router'

const router = createRouter({
  history: createWebHistory(),
  routes: [
    {
      path: '/login',
      name: 'Login',
      component: () => import('@/views/Login.vue'),
      meta: { requiresAuth: false }
    },
    {
      path: '/register',
      name: 'Register',
      component: () => import('@/views/Register.vue'),
      meta: { requiresAuth: false }
    },
    {
      path: '/',
      name: 'Home',
      component: () => import('@/views/Home.vue'),
      meta: { requiresAuth: true }
    }
  ]
})

// 路由守卫
router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('token')

  if (to.meta.requiresAuth && !token) {
    // 需要登录但未登录，跳转到登录页
    next('/login')
  } else if (to.path === '/login' && token) {
    // 已登录访问登录页，跳转到首页
    next('/')
  } else {
    next()
  }
})

export default router
```

---

## 注意事项

1. **Token存储**
   - 推荐使用localStorage存储token（持久化）
   - 如果需要更高安全性，可以使用sessionStorage（关闭浏览器后失效）

2. **Token刷新**
   - 当前实现token有效期为7天
   - 如需自动刷新token，可以在响应拦截器中检测token即将过期时调用刷新接口

3. **跨域问题**
   - 开发环境可以在vite.config.js中配置代理
   - 生产环境需要后端配置CORS（已配置）

4. **错误处理**
   - 统一在Axios响应拦截器中处理错误
   - 避免在每个组件中重复处理

5. **安全建议**
   - 不要在URL中传递敏感信息
   - 密码输入框使用type="password"
   - 登录页面使用HTTPS（生产环境）

---

## 联系方式

如有接口问题，请联系后端开发人员。
